<html xmlns:th="http://www.thymeleaf.org" lang="en">
<html lang="vi">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <th:block th:replace="/ohana/layout/head :: head('Ohana - Tìm ở ghép, phòng trọ siêu nhanh')"/>
    <!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"-->
    <!--            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"-->
    <!--            crossorigin="anonymous"></script>-->
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"-->
    <!--          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">-->
    <!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"-->
    <!--            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"-->
    <!--            crossorigin="anonymous"></script>-->
    <style>
        body {
            background-color: #F6F5F2;
        }

        .X0uZX {
            padding-left: 20px;
        }

        ul {
            list-style-type: none;
        !important;
        }
    </style>
</head>

<body>
<div id="root">
    <div class="app">
        <div class="_3bjUj">
            <!--header-->
            <th:block th:replace="/ohana/layout/header :: header(${userLogin})"/>
            <
            <div class="QZg_h _18fKS">
                <div class="_3oMi4">
                    <div class="_3OgY1"><a href="/"><img
                            src="/resources/ohana/img/8cc95480cbd2708db10ad4b8de56306a.svg"></a>
                        <div class="_1_U71">
                            <div class="_2lKdR">
                                <div class="_3p4ES _1vH0j" id="floating-city-dropdown">
                                    <div class="wj6oE"><span class="icon-location-fill"
                                                             style="color: rgb(247, 52, 134); font-size: 16px;"></span><span
                                            class="_1qNTb">HUẾ</span>
                                    </div>
                                </div>
                                <div class="_1pVEQ"><input id="search" class="bX6zE"
                                                           placeholder="Tìm kiếm theo địa điểm, quận, tên đường..."
                                                           value fdprocessedid="ncxia9">
                                    <div class="_2QckJ"><span class="icon-search"
                                                              style="color: rgb(247, 52, 134); font-size: 24px; align-content: center"></span>
                                    </div>
                                </div>
                                <div class="_1IdUV">
                                    <ul class="b-CdA _11SSO" style="left: 157px;" id="location">
                                    </ul>
                                </div>
                            </div>
                            <div class="_1IdUV">
                                <ul class="b-CdA" style="width: 123px;">
                                    <li class="J_X1w _1vH0j" value="HCM">Huế</li>
<!--                                    <li class="J_X1w _1vH0j GpngF" value="HN">Hà Nội</li>-->
                                </ul>
                                <ul class="b-CdA" style="left: 128px;"></ul>
                            </div>
                        </div>
                    </div>
                    <div>
                    </div>
                </div>
            </div>
        </div>
        <div class="_2fxFG">
            <div class="FMSe2 _3Nvxb">
                <div class="_1say4">
                    <div class="_1Tf_Z _3x9MP"><span class="_2TvH9">Bộ lọc</span>
                        <div class="_1vH0j">
                            <div class="_1Gwyz _1vH0j btn-search"><span>Áp dụng</span></div>
                        </div>
                    </div>
                    <div class="ySUHy">
                        <div class="q49VD">
                            <div class="wzw4X d-flex flex-column">
                                <div class="d-flex justify-content-between w-100">
                                    <span class="_2dNxP">Giá</span>
                                    <span
                                            class="icon-a-down float-end _11wO8 _2enHb" id="btnPrice"
                                            style="color: rgb(51, 51, 51); font-size: 20px;">
                                    </span>
                                </div>
                            </div>
                            <div class="_1ZENx _1-FEc _39FVJ" id="price">
                                <div class="oH889">
                                    <div class="range-slide">
                                        <div class="slide">
                                            <div class="line" id="line" style="left: 0%; right: 0%;"></div>
                                            <span class="thumb" id="thumbMin" style="left: 0%;"></span>
                                            <span class="thumb" id="thumbMax" style="left: 100%;"></span>
                                        </div>
                                        <input class="input-class" id="rangeMin" type="range" max="15000000" min="0"
                                               step="50"
                                               value="0">
                                        <input class="input-class" id="rangeMax" type="range" max="15000000" min="0"
                                               step="50"
                                               value="15000000">
                                    </div>
                                    <div class="display">
                                        <span class="text-start" id="min">0tr</span>
                                        <span class="text-end" id="max" style="width: 50px;">15tr</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="q49VD">
                            <div class="wzw4X d-flex flex-column">
                                <div class="d-flex justify-content-between w-100">
                                    <span class="_2dNxP">Loại phòng</span>
                                    <span
                                            class="icon-a-down float-end _11wO8 _2enHb" id="btnCategory"
                                            style="color: rgb(51, 51, 51); font-size: 20px;">
                                    </span>
                                </div>
                                <div class="_1ZENx _1-FEc X0uZX align-self-start" id="categories">
                                </div>
                            </div>

                        </div>
                        <div class="q49VD">
                            <div class="wzw4X d-flex flex-column">
                                <div class="d-flex justify-content-between w-100">
                                    <span class="_2dNxP">Tiện ích</span>
                                    <span
                                            class="icon-a-down float-end _11wO8 _2enHb" id="btnUtilities"
                                            style="color: rgb(51, 51, 51); font-size: 20px;">
                                    </span>
                                </div>
                                <div class="_1ZENx _1-FEc _1Ed3U align-self-start" id="utilities">
                                </div>
                            </div>
                        </div>
                        <div class="q49VD">
                            <div class="wzw4X d-flex flex-column">
                                <div class="d-flex justify-content-between w-100">
                                    <span class="_2dNxP">Giới tính</span>
                                    <span
                                            class="icon-a-down float-end _11wO8 _2enHb" id="btnGenders"
                                            style="color: rgb(51, 51, 51); font-size: 20px;">
                                    </span>
                                </div>
                                <div class="_1ZENx _1-FEc X0uZX align-self-start" id="genders">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="_1vH0j _3X6_U btn-search">
                        <span>Áp dụng</span>
                    </div>
                </div>
            </div>
            <div class="aR5Eq">
                <div class="TJKfZ _3Nvxb">
                    <th:block th:if="${trend}!=null">
                        <div>
                                            <span style="color: rgb(102, 102, 102);"><a href="/view-all"
                                                                                        style="color: rgb(72, 119, 248);">Huế</a>
                                                 <span class="icon-a-right"
                                                       style="color: rgb(102, 102, 102); font-size: 14px; margin-left: 10px; margin-right: 10px;">
                                                </span>
                                                <span style="color: rgb(102, 102, 102);">Thành phố Huế</span>
                                                <span class="icon-a-right"
                                                      style="color: rgb(102, 102, 102); font-size: 14px; margin-left: 10px; margin-right: 10px;">
                                                </span>
                                            </span>
                            <span style="color: rgb(102, 102, 102);" th:text="${trend.name}"></span>
                        </div>
                    </th:block>
                    <th:block th:if="${provinceName}!=null">
                        <div>
                                            <span style="color: rgb(102, 102, 102);"><a href="/view-all"
                                                                                        style="color: rgb(72, 119, 248);">Huế</a>
                                                <!--                                                 <span class="icon-a-right"-->
                                                <!--                                                       style="color: rgb(102, 102, 102); font-size: 14px; margin-left: 10px; margin-right: 10px;">-->
                                                <!--                                                </span>-->
                                                <!--                                                <span style="color: rgb(102, 102, 102);">Thành phố Huế</span>-->
                                                <span class="icon-a-right"
                                                      style="color: rgb(102, 102, 102); font-size: 14px; margin-left: 10px; margin-right: 10px;">
                                                </span>
                                            </span>
                            <span style="color: rgb(102, 102, 102);" th:text="${locationName}"></span>
                        </div>
                    </th:block>
                    <div class="_1Tf_Z">
                        <span class="_3gUBz">
                            <span class="_2TvH9">Phòng mới nhất</span>
                        </span>
                    </div>
                    <div class="_1RkT-">
                        <section>
                            <div class="data-container"></div>
                        </section>
                        <div id="pagination-demo1">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--footer-->
<th:block th:replace="/ohana/layout/footer :: footer"/>
<th:block th:replace="/ohana/layout/script :: script"/>
</div>
</div>
<script src="/resources/paginationjs-master/paginationjs-master/src/pagination.js"></script>
<script th:inline="javascript">
    let page = {
        url: {
            getAllCategories: App.BASE_URL_API + "/categories",
            getAllUtilities: App.BASE_URL_API + "/utilities",
            getAllGenders: App.BASE_URL_API + "/genders",
            doCreatePost: App.BASE_URL_API + "/posts/postNews",
            doFilter: App.BASE_URL_API + "/posts/filter",
            getAllProvinces: App.BASE_URL_PROVINCE,
        },
        element: {},
        loadData: {},
        commands: {},
        dialogs: {
            elements: {},
            loadData: {},
            commands: {},
            alertDanger: {}
        },
        initializeControlEvent: {},
        // let isClickInside = specifiedElement.contains(event.target)
    }

    let post = new Post();
    let filter = {};
    let listPost = [];
    let min = 0;
    let max = 15000000;

    const calcLeftPosition = value => 100 / (15000000) * (value);

    // Rang: Min, Max

    $('#rangeMin').on('input', function (e) {
        const newValue = parseInt(e.target.value);
        if (newValue + 500000 > max) return;
        min = newValue;
        $('#thumbMin').css('left', calcLeftPosition(newValue) + '%');
        $('#min').html(Math.ceil(newValue / 500000) * 500000 / 1000000 + 'tr');
        $('#line').css({
            'left': calcLeftPosition(newValue) + '%',
            'right': (100 - calcLeftPosition(max)) + '%'
        });
    });

    $('#rangeMax').on('input', function (e) {
        const newValue = parseInt(e.target.value);
        if (newValue - 500000 < min) return;
        max = newValue;
        $('#thumbMax').css('left', calcLeftPosition(newValue) + '%');
        $('#max').html(Math.ceil(newValue / 500000) * 500000 / 1000000 + 'tr');
        $('#line').css({
            'left': calcLeftPosition(min) + '%',
            'right': (100 - calcLeftPosition(newValue)) + '%'
        });
    });

    // END ======


    function doFilter(filter) {
        $.ajax({
            data: JSON.stringify(filter),
            "headers": {
                "Content-Type": "application/json"
            },

            type: "POST",
            url: page.url.doFilter + "?page=0&size=10",
        }).done(function (data) {
            paging(data);
        }).fail(function () {
            showError("Get Filter Fail")
        })
    }

    // Chang handleBtn: btnCategory, btnUtilities, btnGenders

    let isCategoryClick = false

    $("#btnCategory").on('click', function () {
        page.commands.handleCategoryClick(isCategoryClick = !isCategoryClick)
    });

    page.commands.handleCategoryClick = (isClick) => {
        if (isClick) {
            $("#categories").show(250);
            $("#btnCategory").animate({rotate: "90deg"}, 250)
        } else {
            $("#categories").hide(250);
            $("#btnCategory").animate({rotate: "0deg"}, 250)
        }
    }

    let isUtilitieClick = false

    $("#btnUtilities").on('click', function () {
        page.commands.handleUtilitieClick(isUtilitieClick = !isUtilitieClick)
    })

    page.commands.handleUtilitieClick = (isClick) => {
        if (isClick) {
            $("#utilities").show(250);
            $("#btnUtilities").animate({rotate: "90deg"}, 250)
        } else {
            $("#utilities").hide(250);
            $("#btnUtilities").animate({rotate: "0deg"}, 250)
        }
    }

    let isGenderClick = false

    $("#btnGenders").on('click', function () {
        page.commands.handleGenderClick(isGenderClick = !isGenderClick)
    })

    page.commands.handleGenderClick = (isClick) => {
        if (isClick) {
            $("#genders").show(250);
            $("#btnGenders").animate({rotate: "90deg"}, 250)
        } else {
            $("#genders").hide(250);
            $("#btnGenders").animate({rotate: "0deg"}, 250)
        }
    }

    let isPiceClick = false

    $("#btnPrice").on('click', function () {
        page.commands.handlePriceClick(isPiceClick = !isPiceClick)
    })

    page.commands.handlePriceClick = (isClick) => {
        if (isClick) {
            $("#price").show(250);
            $("#btnPrice").animate({rotate: "90deg"}, 250)
        } else {
            $("#price").hide(250);
            $("#btnPrice").animate({rotate: "0deg"}, 250)
        }
    }

    // END =======


    $(".btn-search").on('click', function () {
        filter.priceStarts = min;
        filter.priceEnds = max;

        let utilities = [];
        $.each($("input[name='utilitiesCheckbox']:checked"), function () {
            utilities.push(+$(this).val());
        });
        filter.utilities = utilities;

        filter.categories = +$('input[type="radio"][name="roomCategoriesRadio"]:checked').val();
        filter.gender = +$('input[type="radio"][name="roomGendersRadio"]:checked').val();

        doFilter(filter);
    })


    // GetALl: categories

    page.commands.getAllUtilities = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllUtilities
        }).done(function (data) {
            $("#utilities").html('');
            data.forEach((item) => {
                $('#utilities').append(`
                    <label class="_22Yl9" id="utility_${item.id}">
                        <span class="_39t1S">
                            <span class="${item.icon}" style="color: rgb(51, 51, 51); font-size: 20px;">
                            </span>
                            <span class="vcduZ">${item.name}</span>
                            </span>
                            <input value="${item.id}" type="checkbox" name="utilitiesCheckbox">
                            <span class="_1akYM">
                        </span>
                    </label>
                `);
            });
        }).fail(function () {
            showError('Error')
        })
    }

    page.commands.getAllCategories = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllCategories
        }).done(function (data) {
            $("#categories").html('');
            data.forEach((item) => {
                let str = `<label class="zOnI7" id="categories"><span
                                        class="_1HWTz">${item.title}</span><input value="${item.id}" type="radio" name="roomCategoriesRadio"><span
                                        class="_30lzl"></span>
                           </label>`;
                $("#categories").append(str);
            });
        }).fail(function () {
            showError('Error')
        })
    }

    page.commands.getAllGenders = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllGenders
        }).done(function (data) {
            $("#genders").html('');
            data.forEach((item) => {
                let str = `<label class="zOnI7" id="male"><span
                                        class="_1HWTz">${item.name}</span><input value="${item.id}" type="radio" name="roomGendersRadio"><span
                                        class="_30lzl"></span>
                           </label>`;
                $("#genders").append(str);
            });
        }).fail(function () {
            showError('Error')
        })
    }


    $(function () {
            let wardId = [[${wardId}]];
            let provinceName = [[${provinceName}]];
            let locationName = [[${locationName}]];
            let mess = [[${mess}]];

            $("#price").hide();

            $("#categories").hide();
            page.commands.getAllCategories();

            $("#genders").hide();
            page.commands.getAllGenders();

            $("#utilities").hide();
            page.commands.getAllUtilities();

            if (mess != null) {
                showError(mess);
                const myTimeout = setTimeout(redirectAllListPost, 1000);

                function redirectAllListPost() {
                    location.href = App.DOMAIN;
                }
            } else if (wardId != null) {
                filter.wardId = wardId;
                console.log("có warDid")
            } else if (provinceName != null && locationName != null) {
                console.log("có provinceName")
                filter.provinceName = provinceName;
                filter.locationName = locationName;
            }

            filter.priceStarts = min;
            filter.priceEnds = max;

            let utilities = [];
            $.each($("input[name='utilitiesCheckbox']:checked"), function () {
                utilities.push(+$(this).val());
            });
            filter.utilities = utilities;

            filter.categories = +$('input[type="radio"][name="roomCategoriesRadio"]:checked').val();

            filter.gender = +$('input[type="radio"][name="roomGendersRadio"]:checked').val();
            doFilter(filter)
        }
    )

    function paging(data) {
        (function (name) {
            var container = $('#pagination-' + name);
            var sources = function () {
                var result = [];
                data.content.forEach(item => {
                    result.push(item);
                })
                // for (var i = 1; i < 196; i++) {
                //     result.push(i);
                // }
                return result;
            }();
            var options = {
                dataSource: sources,
                callback: function (response, pagination) {
                    window.console;
                    let str = '<ul>';
                    $.each(response, function (index, item) {
                        post = item;
                        let typeRoom;
                        switch (post.category.id) {
                            case 1:
                            case 2:
                                typeRoom = "tr/phòng"
                                break;
                            case 3:
                                typeRoom = "tr/người"
                                break;
                            case 4:
                            case 5:
                                typeRoom = "tr/căn"
                                break;
                        }

                        function checkPrice(price) {
                            if (price >= 1000000) {
                                return price / 1000000;
                            } else {
                                return "<1";
                            }
                        }

                        let image_thumbnail = App.BASE_URL_CLOUD_IMAGE + "/" + App.SCALE_IMAGE_W600_H650_Q100 + "/" + "post_images/" + post.thumbnailId;

                        let price = checkPrice(post.rentHouse.price);
                        let gender;
                        if (post.rentHouse.gender.id == 1) {
                            gender = "Nam/Nữ";
                        } else {
                            gender = post.rentHouse.gender.name;
                        }

                        str += `<li>
                     <div class="nctjX"><a target="_blank" href="/room/${post.id}">
                            <div class="X8svI _2DJkz">
                                <div class="pcGxo">
                                    <div class="_1Gm0b"><img
                                            src="/resources/ohana/img/20c8373d39e30d04cde885686abc2987.png"
                                            alt="verified-img" class="_1TPDO"></div>
                                    <img src=${image_thumbnail}
                                         alt="room-img"
                                         class="_1IOeB">
                                </div>
                                <div class="_228LH">
                                    <p class="_3xXyQ" >${post.title}</p>
                                    <div class="_27rcQ">
                                        <div class="_3piN7">
                                            <div class="wpwoK"><span class="icon-nav-home"
                                                                     style="color: rgb(102, 102, 102); font-size: 24px; margin-right: 8px;"></span><span
                                                   >${post.category.title}</span>
                                                   <span
                                                                     style="color: rgb(102, 102, 102); font-size: 24px; margin-right: 8px;"></span><span
                                                   >Sức chứa: ${post.rentHouse.capacity}</span></div>
                                            <div class="_3TYbx"><span><span class="icon-nav-roomate"
                                                                            style="color: rgb(102, 102, 102); font-size: 24px; margin-right: 8px;"
                                                                           >${gender}</span></span><span><span
                                                    class="icon-squaremeter"
                                                    style="color: rgb(102, 102, 102); font-size: 24px; margin-right: 8px;"
                                                   >${post.rentHouse.area}</span>m<sup>2</sup></span>
                                            </div>
                                            <div class="_1jHdY"><span class="icon-location"
                                                                      style="color: rgb(102, 102, 102); font-size: 24px; margin-right: 8px;"></span><span
                                                    class="uKi2L"
                                                   >${post.location.line1}, ${post.location.wardName}, ${post.location.districtName}, ${post.location.provinceName}</span>
                                            </div>
                                        </div>
                                        <div class="_1ezn1">
                                            <span class="_36r7N">${price}</span>
                                            <span class="_11LqE">${typeRoom}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a></div></li>
                    `;
                        // $(container).append(str);
                    });
                    str += '</ul>';
                    container.prev().html(str);


                }
            };

            //$.pagination(container, options);

            container.addHook('beforeInit', function () {
                window.console;
            });
            container.pagination(options);

            container.addHook('beforePageOnClick', function () {
                window.console;
                //return false
            });
            if (data.length == 0) {
                $('#pagination-demo1').html("");
                let str = `<ul><li><div class="nctjX"><div class="X8svI _2DJkz"> <div class="pcGxo"><div class="_228LH">
                                Không có bài đăng nào phù hợp
                            </div></div></div></div></li></ul>`;
                $(container).append(str);
            }
        })('demo1');
    }


    $("#search").on('input', () => {
        let valueSearch = $("#search").val();
        $("#location").html("");
        if (valueSearch.length > 2) {
            $("._1IdUV").show(250);
            $.ajax({
                type: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                data: JSON.stringify({keyword: valueSearch})
                ,
                url: App.BASE_URL_API + "/posts/filter?page=0&size=5"
            }).done(function (data) {
                let locationDetail;
                $("#location").empty()
                data.content.forEach(({location}) => {
                    let item = location
                    if (item.wardName == null) {
                        locationDetail = item.districtName;
                    } else {
                        locationDetail = item.wardName;
                    }
                    let str = `<li role="button" class="li-search" value="${item.wardId}" onclick="doSearchFilter(this.value)">${item.line1}, ${item.wardName}</li>`;
                    $("#location").append(str);
                })
            }).fail(function () {
                showError('Error')
            })
        }
    })

    let specifiedElement = document.getElementById('search');
    //   I'm using "click" but it works with any event
    document.addEventListener('click', function (event) {
        let isClickInside = specifiedElement.contains(event.target);

        if (!isClickInside) {
            $("#search").val("");
            $("#location").html("");
        }
    });

    function doSearchFilter(wardName) {
        let location = {
            keyword: $("#search").val(),
            locationFilter: {
                wardId: wardName
            }
        }
        doFilter(location);
        $("._1IdUV").hide(250);
    }


</script>
</body>

</html>